<!doctype html><html><head><meta charset="utf-8"><title>on the humble Berkeley Packet Filter, and the hungering pits of madness</title><style type="text/css">body {padding:0 1em;margin:auto;max-width:40em}:root {--accent:319} body { font-size: 16pt; page-break-before: always; } h1 { page-break-before: always; } h1,h2,h3,h4,h5,h6 { page-break-after: avoid; }  body { padding: 0 2.5em !important } h1,h2,h3,h4,h5,h6 { border-bottom: 1px solid hsl(var(--accent), 100%, 66%); } h1 { font-size: 200%; border-bottom-style: double !important; border-bottom-width: 3px !important; margin: 0em -1em; } h2 { font-size: 130%; margin: 0em -0.7em; } h3 { font-size: 110%; margin: 0em -0.5em; } h4 { font-size: 100%; font-weight: normal; margin: 0em -0.2em; } h5 { font-size: 90%; font-weight: normal; } h6 { font-size: 80%; font-weight: normal; } h3, h4, h5, h6 { border-bottom-style: dotted !important; } h1,h2,h3,h4,h5,h6 { margin-top: 0; margin-bottom: 0; } :is(h1,h2,h3,h4,h5,h6) + p { margin-top: 0.4em; }  p { margin: 0.7em 0; text-align: justify; } section { margin: 1.2em 0; } section:first-child { margin-top: 0; }  @media screen { a[href].fnref { text-decoration-style: dashed; color: hsl(var(--accent), 100%, 66%); text-decoration-color: hsla(var(--accent), 100%, 66%, 0.4); } a[href]:hover.fnref { color: hsl(var(--accent), 100%, 82%); text-decoration-color: hsla(var(--accent), 100%, 66%, 0.7); } } aside.footnote { font-family: 90%; grid-template-columns: 1em 1fr min-content; grid-template-rows: 1fr min-content; position: fixed; padding: 1em; background: hsl(var(--accent), 100%, 12%); margin:auto; } @media screen { aside.footnote { display: grid; left: 10em; right: 10em; max-width: calc(40em + 2em); max-height: 30vw; bottom: 1em; border: 1px solid black; transform: translateY(200%); transition: 0.4s; z-index: 100; } aside.footnote:target { transform: translateY(0%); } #cover { position: fixed; top: 0; left: 0; height: 100vh; width: 100vw; background: linear-gradient(to top, hsla(var(--accent), 100%, 4%, 0.8), hsla(var(--accent), 100%, 4%, 0.4)); opacity: 0%; transition: 1s; pointer-events: none; backdrop-filter: blur(0px); } aside.footnote:target ~ #cover { opacity: 100%; pointer-events: all; backdrop-filter: blur(5px); } } @media screen and (max-width: calc(40em + 20em)) { aside.footnote { left: 1em; right: 1em; } } @media print { aside.footnote { display: grid; position: relative; } aside.footnote:first-of-type { border-top: 1px solid black; } } aside.footnote > a[href="#0"]{ grid-row: 2/3; grid-column: 3/4; display: block; text-align: center; padding: 0 0.3em; text-decoration: none; background: hsl(var(--accent), 100%, 26%); color: hsl(var(--accent), 100%, 90%); border: 1px solid black; margin-top: 0.6em; font-size: 150%; -webkit-user-select: none; -ms-user-select: none; user-select: none; -webkit-user-drag: none; user-drag: none; } aside.footnote > a[href="#0"]:hover { background: hsl(var(--accent), 100%, 34%); color: hsl(var(--accent), 100%, 100%); } aside.footnote > a[href="#0"]:active { background: hsl(var(--accent), 100%, 14%); color: hsl(var(--accent), 100%, 42%); } @media print { aside.footnote > a[href="#0"]{ display:none; } } aside.footnote > div.number { text-align:right; grid-row: 1/2; grid-column: 1/2; } aside.footnote > .text { grid-row: 1/2; grid-column: 2/4; padding-left: 1em; overflow-y: auto; margin-top: 0; } aside.footnote > .text > :first-child { margin-top: 0; }  code { display: inline-block; background: hsl(var(--accent), 100%, 0%); color: hsl(var(--accent), 100%, 66%); font-family: monospace; font-size: 90%; padding: 2px 5px; user-select: all; }  @counter-style enclosed { system: extends decimal; prefix: "("; suffix: ") "; } ul, ol { padding: 0 1em; } li { padding: 0.1em 0; }  @media screen { body { background: hsl(var(--accent), 100%, 10%); color: hsl(var(--accent), 100%, 90%) } a[href] { color: hsl(var(--accent), 100%, 66%); text-decoration-color: hsla(var(--accent), 100%, 66%, 0.4); } a[href]:hover { color: hsl(var(--accent), 100%, 82%); text-decoration-color: hsla(var(--accent), 100%, 66%, 0.7); } h1 { color: hsl(var(--accent), 100%, 100%); } h2 { color: hsl(var(--accent), 100%, 100%); } h3 { color: hsl(var(--accent), 100%, 100%); } h4 { color: hsl(var(--accent), 100%, 90%); } h5,h6 { color: hsl(var(--accent), 100%, 74%); } } @media print { a[href] { text-decoration: none; color: black; font-weight: bold; } h1,h2,h3,h4,h5,h6 { border-bottom: 1px black; } } </style></head><body><section id="x-1"><h1>on the humble Berkeley Packet Filter, and the hungering pits of madness</h1><p>i have a hard time expressing just how colossally boneheaded everything around BPF is.</p><p>like. okay. some background here. i'm an SF writer. i put an unhealthy amount of effort into worldbuilding. my series bible for <a href="https://%CA%9E.cc/fic/spirals">Spirals</a> is longer than the entire published Spirals canon. among other details, i have devoted serious thought to how exactly computers work in that setting (which is not of our universe, present, future, or past).</p><p>the most detailed notes i put together are about how the <a href="https://%CA%9E.cc/fic/spirals/society">Society of Worlds</a> would build its computers and architect its OS. and the main conclusion i came to is, they would make the physical hardware as simple as possible (but no simpler!) while maintaining adequate performance, and leave the actual thinking up to the software. possibly an <a class="fnref" href="#x-2">OISC<sup>1</sup></a> design with no MMU, no privilege rings, no preemptive multitasking, none of that bullshit.</p><p>	</p><p>instead, for security and multitasking stability, their applications are all written in managed code. there's no distinction between a kernel and a machine-code compiler, between &#34;user space&#34; and &#34;kernel space&#34;. what there <em>is</em> is a very small base of unmanaged, trusted code (signed with the machine's root-of-trust key, usually a Tel Casran -&#62; planetary authority -&#62; <em><a href="https://%CA%9E.cc/fic/spirals/glossary.html#ranuir.d.rantal">rantal</a></em> authority certificate chain) that makes up the bootloader and the smallest possible part of the kernel. and the rest is <em>high-level</em> managed code, which where necessary is JITted by the kernel. there's no need for a &#34;verifier&#34; because the fundamental constraints of the managed language(s) are such that there's no way to express unsafe operations. non-constant loop? the JIT will just insert periodic jumps back into the kernel (no need for a syscall instruction!) and there's nothing the managed code can do about it. yes, the compiler itself would be complicated, and it could have errors. but i'm pretty damn sure that </p><ol><li>it would be less complicated that the 6-dimensional fractal rat's nest that is the <em><a class="fnref" href="#x-3">Loki-spawned<sup>2</sup></a> Linux kernel</em>, wherein you are <em>almost certain</em> to be eaten by a grue</li><li>in over a thousand years of technological civilization under responsible leadership, and with no hype-gargling corporate sociopaths to appease, <em>they've worked out the kinks by now</em>.</li></ol><p>(2) is obviously utopian beyond what even the Chinese can hope to achieve in the near term. (1), however, is entirely plausible even in this vale of tears where Scrum exists and high-speed rail doesn't.</p><p>now, let us consider the progression of affairs in that sad sublunary realm, wherein we mortals dwell.</p><ol><li>CISC arches get unfathomably CISCier with each year that passes</li><li>a modern CPU is an eldritch artifact beyond human ken, which only the most exalted of dark cults can hope to assemble, through degenerate rites that leech the earth of its vital essence</li><li>kernel devs invest absolutely everything into a privilege ring architecture that locks userspace out of the kernel's secrets at the hardware level</li><li>kernel devs continue their traditional pastime of cramming inane new features into the process context</li><li>kernel devs note with alarm and confusion that kernel&#60;-&#62;userspace context switches are, impossibly, only getting more complex and difficult and <em>slow</em></li><li>the Black Coven of Mountain View grows angry, as context switches cost it approximately $69 trillion dollars per full moon</li><li>the Black Coven sends its foulest liches to infest the LKML until it stops bleeding money</li><li>kernel devs realize, hey, this whole context switching problem, it just goes away if we can smuggle the code into kernel space. somehow. will this appease the Google lich horde? please O Daemon-Sultan Azathoth have mercy</li><li>kernel devs <a class="fnref" href="#x-4">do not understand<sup>3</sup></a> the concept of managed code, and so are doomed to reinvent it. poorly</li><li>rather than using high-level structured constructs that can be reasonably interrogated and symbolically manipulated, they seize on the nearest available bytecode format like a drowning man gasping for air. mercifully, <a class="fnref" href="#x-5">this is not wasm<sup>4</sup></a></li><li>linux grows an entire parallel model of programming and security, with a JIT compiler and &#34;verifier&#34; integrated into the kernel itself, which has nothing whatsoever in common with conventional Linux application code, and which 99% of software will never need or (so long as divine mercy remains with us) use</li><li>the liches grudgingly stop devouring the souls of core contributors, but the kernel devs have made their bed and must now sleep in it forevermore</li><li>shockingly to absolutely everybody, it proves algorithmically nontrivial to prove that a sequence of arbitrary bytecode compiles down to a harmless series of instructions across a broad range of ISAs with the built-in get-out-of-security-free feature known as speculative execution. i tell ya, nobody saw this coming!</li><li>BPF exploits begin to crop up with monotonous regularity, yet those accursed acolytes of the Crawling Chaos who abase their tongues by the unclean spell-words  &#34;unprivileged BPF&#34; are inexplicably not hung from the nearest gibbet and doused in holy water</li><li>kernel devs undertake a nigh-microsoftian campaign of firefighting, which continues until the heat death of the universe</li></ol><p>we now live in the worst of both worlds. we have all the complexity of Society-style in-kernel compilation <em>and then some</em>, all the complexity of hardware privilege management, all the performance of rapid-fire context switching, all the security guarantees of a Black Hat Spectre exploit competition, all the user-friendliness of the <em>Kitāb al-῾Azīf</em>, all the tractability of <a class="fnref" href="#x-6">the halting problem<sup>5</sup></a>, and none of the benefits of managed code. the scope of BPF will soon enter its very own inflationary epoch, and the Linux kernel will be stuck maintaining this abortion until the stars come right and the Great Old Ones mercifully bring an end to the suffering of software developers by driving us all mad.</p><p>epilogue: due to the use of a raw bytecode format, corporations can now ship binary kernel drivers <a class="fnref" href="#x-7">without ever sharing the source code<sup>6</sup></a>. executives across all the Nine Hells cackle with hysterical glee and begin developing sexecution/rowhammer rootkits to enforce their drm</p><p>personally, i disable BPF support at build time in the versions of the kernel i use. i pray to the Fates that this last refuge of sanity remain open to us. but recall, in its great wisdom, the Beast removed (okay, hid) the option to disable ecmascript in Failfox, proclaiming that ES support was as fundamental to the Web as HTML or CSS. the day does fast approach whereupon my text editor shall demand <code>CAP_BPF</code> to run, and on that day, if gods be merciful and kind, <em>I shall perish.</em></p></section><aside class="footnote" id="x-2"><div class="number">1</div><div class="text"><p>yes, these can in fact be as performant as our overgrown CISC ISAs</p></div><a href="#0">⤫</a></aside><aside class="footnote" id="x-3"><div class="number">2</div><div class="text"><p>i am absolutely not implying that Linus Torvalds is an avatar of the trickster god of chaos and strife. unfortunately, most of the other linux contributors <em>unambiguously are</em></p></div><a href="#0">⤫</a></aside><aside class="footnote" id="x-4"><div class="number">3</div><div class="text"><p>i am probably being slightly unfair to the Linux development community throughout this jeremiad.</p><p>well, tough. life ain't fair.</p></div><a href="#0">⤫</a></aside><aside class="footnote" id="x-5"><div class="number">4</div><div class="text"><p>remember, children, that things could always be worse. yes, you may live in a dumpster behind PornHub HQ, eking out a living by selling your vital organs to passers-by, with a meth habit the size of Sagittarius A* and a revolving cast of abusive boyfriends, but look on the bright side -- it's not raining snakes!</p><p>yet.</p></div><a href="#0">⤫</a></aside><aside class="footnote" id="x-6"><div class="number">5</div><div class="text"><p>wow yes i am infact exaggerating you nerd. you dweeb. you unsalvageable dork. you unclean spawn of Hacker News by Shub-Niggurath, who blacken the stars by your very footstep. <em>go outside and touch grass</em></p></div><a href="#0">⤫</a></aside><aside class="footnote" id="x-7"><div class="number">6</div><div class="text"><p>yes, i <em>am</em> aware that BPF code has to attest GPL compliance. and if you think that will make the slightest difference in either legal or practical terms, boy do i have a bridge to sell you.</p><p>effective restraints of this form <strong>are</strong> actually possible, i believe, through legal chicanery pioneered by nintendo -- just refuse to run the code if it doesn't contain an unambiguously copywritable sequence of data (say, a BPF logo), whose copyright is owned by the FSF and licensed to anyone who makes their full source code available.</p><p>but that's not what they did. instead, your code has to <a class="fnref" href="#x-8"><sup>7</sup></a> that it's GPL-compliant. as if that means anything for a bytecode format -- any fool can run <code>objdump</code> on a binary! no, kernel devs may be devious enough to use five-star pointer indirections, but they're not devious enough to out-lawyer microsoft.</p></div><a href="#0">⤫</a></aside><div id="cover"></div></body></html>